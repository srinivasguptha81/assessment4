{% extends "base.html" %}
{% block title %}Session Detail{% endblock %}
{% block page_title %}Session Detail{% endblock %}

{% block extra_css %}
<style>
.method-tag {
  display: inline-flex;
  align-items: center;
  gap: 5px;
  font-size: 11px;
  padding: 3px 9px;
  border-radius: 20px;
  font-weight: 500;
}
.method-ai     { background: rgba(201,168,76,0.15); color: #7a5c00; border: 1px solid rgba(201,168,76,0.3); }
.method-manual { background: var(--parchment); color: var(--slate); border: 1px solid var(--rule); }
</style>
{% endblock %}

{% block content %}

<!-- BANNER -->
<div class="page-banner fade-up">
  <div class="banner-tag">ğŸ“‹ {{ session.course.code }}</div>
  <div class="banner-title">{{ session.course.name }}</div>
  <div class="banner-sub">
    {{ session.date }} Â· {{ session.start_time|time:"H:i" }} â€“ {{ session.end_time|time:"H:i" }}
    &nbsp;Â·&nbsp; Faculty: {{ session.created_by.user.get_full_name }}
  </div>
</div>

<!-- SUMMARY STATS -->
<div class="row g-3 mb-4">
  <div class="col-md-3 fade-up-1">
    <div class="stat-card gold">
      <span class="stat-icon">ğŸ‘¥</span>
      <span class="stat-value">{{ total }}</span>
      <div class="stat-label">Total Students</div>
    </div>
  </div>
  <div class="col-md-3 fade-up-2">
    <div class="stat-card green">
      <span class="stat-icon">âœ…</span>
      <span class="stat-value">{{ present }}</span>
      <div class="stat-label">Present</div>
    </div>
  </div>
  <div class="col-md-3 fade-up-3">
    <div class="stat-card rust">
      <span class="stat-icon">âŒ</span>
      <span class="stat-value">{{ absent }}</span>
      <div class="stat-label">Absent</div>
    </div>
  </div>
  <div class="col-md-3 fade-up-4">
    <div class="stat-card blue">
      <span class="stat-icon">ğŸ“Š</span>
      <span class="stat-value">{{ present_pct }}%</span>
      <div class="stat-label">Attendance Rate</div>
    </div>
  </div>
</div>

<!-- EXTRA INFO ROW -->
<div class="row g-3 mb-4">
  {% if late %}
  <div class="col-auto fade-up-2">
    <div style="background:white;border:1px solid var(--rule);border-radius:10px;padding:12px 18px;display:flex;align-items:center;gap:10px;">
      <span style="font-size:18px;">â°</span>
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;line-height:1;">{{ late }}</div>
        <div style="font-size:11px;color:var(--slate);text-transform:uppercase;letter-spacing:0.08em;">Late</div>
      </div>
    </div>
  </div>
  {% endif %}
  {% if excused %}
  <div class="col-auto fade-up-3">
    <div style="background:white;border:1px solid var(--rule);border-radius:10px;padding:12px 18px;display:flex;align-items:center;gap:10px;">
      <span style="font-size:18px;">ğŸ“</span>
      <div>
        <div style="font-family:'Playfair Display',serif;font-size:20px;font-weight:700;line-height:1;">{{ excused }}</div>
        <div style="font-size:11px;color:var(--slate);text-transform:uppercase;letter-spacing:0.08em;">Excused</div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- ACTION BUTTONS â€” choose how to re-mark -->
<div class="lpu-card mb-4 fade-up-2">
  <div class="lpu-card-header">
    <div class="lpu-card-title">Re-mark Attendance</div>
    <span style="font-size:12px;color:var(--slate);">Choose a method to update records</span>
  </div>
  <div style="padding:18px 22px;display:flex;gap:14px;align-items:stretch;flex-wrap:wrap;">

    <!-- MANUAL OPTION -->
    <div style="flex:1;min-width:200px;background:var(--parchment);border-radius:12px;padding:18px 20px;border:1px solid var(--rule);">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <span style="font-size:22px;">âœï¸</span>
        <div style="font-weight:600;font-size:14px;">Manual Marking</div>
      </div>
      <div style="font-size:12.5px;color:var(--slate);margin-bottom:14px;line-height:1.6;">
        Change individual student status. Overrides existing records. Best for corrections.
      </div>
      <a href="{% url 'attendance:mark_attendance' session.id %}" class="btn-ink" style="font-size:12.5px;padding:8px 18px;width:100%;justify-content:center;">
        <i class="bi bi-pencil-square"></i> Mark Manually
      </a>
    </div>

    <!-- AI OPTION -->
    <div style="flex:1;min-width:200px;background:rgba(201,168,76,0.06);border-radius:12px;padding:18px 20px;border:2px solid rgba(201,168,76,0.3);">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
        <span style="font-size:22px;">ğŸ¤–</span>
        <div style="font-weight:600;font-size:14px;color:var(--gold);">AI Face Recognition</div>
      </div>
      <div style="font-size:12.5px;color:var(--slate);margin-bottom:14px;line-height:1.6;">
        Upload a new class photo. AI detects faces and overwrites all records automatically.
      </div>
      <a href="{% url 'attendance:ai_mark' session.id %}" class="btn-gold" style="font-size:12.5px;padding:8px 18px;width:100%;justify-content:center;">
        <i class="bi bi-robot"></i> Run AI Recognition
      </a>
    </div>

  </div>
</div>

<!-- RECORDS TABLE -->
<div class="lpu-card fade-up-3">
  <div class="lpu-card-header">
    <div class="lpu-card-title">Attendance Records</div>
    <div style="display:flex;align-items:center;gap:10px;">
      <!-- Legend -->
      <span class="method-tag method-ai"><i class="bi bi-robot"></i> AI</span>
      <span class="method-tag method-manual"><i class="bi bi-pencil"></i> Manual</span>
    </div>
  </div>
  <table class="lpu-table">
    <thead>
      <tr>
        <th>#</th>
        <th>Student</th>
        <th>Reg. No.</th>
        <th>Status</th>
        <th>Marked By</th>
        <th>Marked At</th>
      </tr>
    </thead>
    <tbody>
      {% for record in records %}
      <tr>
        <td class="mono" style="font-size:11px;color:var(--slate);">{{ forloop.counter }}</td>
        <td>
          <div style="display:flex;align-items:center;gap:9px;">
            <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--gold),var(--gold-light));display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:600;color:var(--ink);flex-shrink:0;text-transform:uppercase;">
              {{ record.student.user.first_name|first }}{{ record.student.user.last_name|first }}
            </div>
            <div style="font-weight:500;font-size:13px;">{{ record.student.user.get_full_name }}</div>
          </div>
        </td>
        <td class="mono" style="font-size:12px;color:var(--slate);">{{ record.student.registration_no }}</td>
        <td>
          {% if record.status == 'P' %}
            <span class="status-badge badge-present">â— Present</span>
          {% elif record.status == 'A' %}
            <span class="status-badge badge-absent">â— Absent</span>
          {% elif record.status == 'L' %}
            <span class="status-badge badge-late">â— Late</span>
          {% else %}
            <span class="status-badge badge-excused">â— Excused</span>
          {% endif %}
        </td>
        <td>
          {% if record.ai_verified %}
            <span class="method-tag method-ai"><i class="bi bi-robot"></i> AI</span>
          {% else %}
            <span class="method-tag method-manual"><i class="bi bi-pencil"></i> Manual</span>
          {% endif %}
        </td>
        <td class="mono" style="font-size:11px;color:var(--slate);">{{ record.marked_at|date:"d M, H:i" }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="6" style="text-align:center;padding:32px;color:var(--slate);">
          No records yet.
          <a href="{% url 'attendance:mark_attendance' session.id %}" style="color:var(--gold);">Mark manually â†’</a>
          or
          <a href="{% url 'attendance:ai_mark' session.id %}" style="color:var(--gold);">Use AI â†’</a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- BACK BUTTON -->
<div class="mt-3 fade-up-4">
  <a href="{% url 'attendance:faculty_dashboard' %}" class="btn-outline">
    <i class="bi bi-arrow-left"></i> Back to Dashboard
  </a>
</div>

{% endblock %}