{% extends 'base.html' %}
{% block title %}{{ stall.name }} ‚Äî Menu{% endblock %}

{% block extra_css %}
<style>
  .menu-header {
    background: linear-gradient(135deg, var(--ink), #1a2a1a);
    border-radius: 14px;
    padding: 24px 28px;
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 24px;
  }
  .menu-header-icon {
    font-size: 48px;
    line-height: 1;
    flex-shrink: 0;
  }
  .menu-header h1 {
    font-family: 'Playfair Display', serif;
    color: var(--gold);
    font-size: 22px;
    margin: 0 0 4px 0;
  }
  .menu-header p { color: rgba(255,255,255,0.55); font-size: 12.5px; margin: 0; }

  .cart-float {
    position: sticky;
    top: 80px;
    background: var(--ink);
    color: white;
    border-radius: 12px;
    padding: 16px 18px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 13.5px;
    font-weight: 500;
    transition: all 0.3s;
    z-index: 100;
  }
  .cart-float.hidden { display: none; }
  .cart-float .cart-total { color: var(--gold); font-weight: 700; font-size: 15px; }
  .cart-float a {
    background: var(--gold);
    color: var(--ink);
    padding: 8px 18px;
    border-radius: 8px;
    font-size: 12.5px;
    font-weight: 700;
    text-decoration: none;
    transition: opacity 0.2s;
  }
  .cart-float a:hover { opacity: 0.85; text-decoration: none; }

  .category-section { margin-bottom: 32px; }
  .category-label {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    font-weight: 600;
    color: var(--ink);
    border-bottom: 2px solid var(--rule);
    padding-bottom: 8px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .menu-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 14px;
  }

  .menu-item-card {
    background: white;
    border: 1px solid var(--rule);
    border-radius: 12px;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .menu-item-card:hover {
    border-color: var(--gold);
    box-shadow: 0 4px 16px rgba(0,0,0,0.07);
  }
  .menu-item-card.out-of-stock {
    opacity: 0.5;
    pointer-events: none;
  }

  .item-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; }
  .item-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--ink);
    line-height: 1.3;
  }
  .item-price {
    font-family: 'Playfair Display', serif;
    font-size: 15px;
    font-weight: 700;
    color: var(--gold);
    flex-shrink: 0;
  }
  .item-desc {
    font-size: 12px;
    color: var(--slate);
    line-height: 1.5;
  }
  .item-meta {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .veg-dot {
    width: 14px; height: 14px;
    border-radius: 3px;
    border: 1.5px solid;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    font-size: 8px;
  }
  .veg-dot.veg { border-color: #16a34a; color: #16a34a; }
  .veg-dot.nonveg { border-color: #dc2626; color: #dc2626; }

  .prep-tag {
    font-size: 10.5px;
    color: var(--slate);
    display: flex;
    align-items: center;
    gap: 3px;
  }
  .out-tag {
    font-size: 10.5px;
    color: #dc2626;
    font-weight: 600;
    background: #fef2f2;
    padding: 2px 8px;
    border-radius: 4px;
  }

  .qty-ctrl {
    display: flex;
    align-items: center;
    gap: 0;
    margin-top: auto;
    border: 1px solid var(--rule);
    border-radius: 8px;
    overflow: hidden;
    width: fit-content;
  }
  .qty-btn {
    background: none;
    border: none;
    padding: 7px 13px;
    font-size: 16px;
    cursor: pointer;
    color: var(--ink);
    transition: background 0.15s;
    line-height: 1;
  }
  .qty-btn:hover { background: var(--parchment); }
  .qty-display {
    padding: 7px 12px;
    font-size: 13px;
    font-weight: 700;
    min-width: 32px;
    text-align: center;
    border-left: 1px solid var(--rule);
    border-right: 1px solid var(--rule);
  }

  .add-btn {
    background: var(--ink);
    color: var(--gold);
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 12.5px;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    margin-top: auto;
    transition: opacity 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
  }
  .add-btn:hover { opacity: 0.85; }
  .add-btn.added { background: #16a34a; color: white; }
</style>
{% endblock %}

{% block content %}

<!-- Header -->
<div class="menu-header">
  <div class="menu-header-icon">
    {% if stall.photo %}<img src="{{ stall.photo.url }}" style="width:60px;height:60px;border-radius:10px;object-fit:cover;">
    {% else %}üçΩ{% endif %}
  </div>
  <div>
    <h1>{{ stall.name }}</h1>
    <p><i class="bi bi-geo-alt"></i> {{ stall.location }}
       &nbsp;¬∑&nbsp; <i class="bi bi-clock"></i> {{ stall.opens_at|time:"g:i A" }} ‚Äì {{ stall.closes_at|time:"g:i A" }}</p>
    {% if stall.description %}<p style="margin-top:4px;">{{ stall.description }}</p>{% endif %}
  </div>
  <div style="margin-left:auto;text-align:right;flex-shrink:0;">
    <a href="{% url 'food:cart' stall.id %}" class="btn-gold" style="position:relative;">
      <i class="bi bi-cart3"></i> Cart
      {% if cart_count > 0 %}
        <span style="position:absolute;top:-8px;right:-8px;background:#dc2626;color:white;border-radius:50%;width:18px;height:18px;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:700;">{{ cart_count }}</span>
      {% endif %}
    </a>
  </div>
</div>

<!-- Sticky cart bar (shown via JS when items added) -->
<div class="cart-float" id="cartBar" {% if not cart_count %}style="display:none;"{% endif %}>
  <div>
    <i class="bi bi-cart3"></i>
    <span id="cartBarCount">{{ cart_count }}</span> item(s) in cart
  </div>
  <span class="cart-total" id="cartBarTotal"></span>
  <a href="{% url 'food:cart' stall.id %}">Checkout ‚Üí</a>
</div>

<!-- Categories -->
{% for category in categories %}
{% with items=category.menuitem_set.all %}
{% if items %}
<div class="category-section">
  <div class="category-label">
    {{ category.icon }} {{ category.name }}
  </div>
  <div class="menu-grid">
    {% for item in items %}
    {% if item.is_available %}
    <div class="menu-item-card" id="card-{{ item.id }}">
      <div class="item-top">
        <div class="item-name">{{ item.name }}</div>
        <div class="item-price">‚Çπ{{ item.price }}</div>
      </div>
      {% if item.description %}
      <div class="item-desc">{{ item.description }}</div>
      {% endif %}
      <div class="item-meta">
        <span class="veg-dot {% if item.is_veg %}veg{% else %}nonveg{% endif %}">{% if item.is_veg %}‚óè{% else %}‚óè{% endif %}</span>
        <span class="prep-tag"><i class="bi bi-stopwatch"></i> {{ item.prep_time }} min</span>
      </div>
      <button class="add-btn" onclick="addToCart({{ item.id }}, '{{ item.name }}', {{ item.price }}, this)" id="btn-{{ item.id }}">
        <i class="bi bi-plus-circle"></i>
        <span id="btn-text-{{ item.id }}">Add to Cart</span>
      </button>
    </div>
    {% else %}
    <div class="menu-item-card out-of-stock">
      <div class="item-top">
        <div class="item-name">{{ item.name }}</div>
        <div class="item-price">‚Çπ{{ item.price }}</div>
      </div>
      <div class="item-meta">
        <span class="out-tag">Out of Stock</span>
      </div>
    </div>
    {% endif %}
    {% endfor %}
  </div>
</div>
{% endif %}
{% endwith %}
{% endfor %}

{% if uncategorized %}
<div class="category-section">
  <div class="category-label">üç¥ Other Items</div>
  <div class="menu-grid">
    {% for item in uncategorized %}
    <div class="menu-item-card" id="card-{{ item.id }}">
      <div class="item-top">
        <div class="item-name">{{ item.name }}</div>
        <div class="item-price">‚Çπ{{ item.price }}</div>
      </div>
      {% if item.description %}
      <div class="item-desc">{{ item.description }}</div>
      {% endif %}
      <div class="item-meta">
        <span class="veg-dot {% if item.is_veg %}veg{% else %}nonveg{% endif %}">‚óè</span>
        <span class="prep-tag"><i class="bi bi-stopwatch"></i> {{ item.prep_time }} min</span>
      </div>
      <button class="add-btn" onclick="addToCart({{ item.id }}, '{{ item.name }}', {{ item.price }}, this)" id="btn-{{ item.id }}">
        <i class="bi bi-plus-circle"></i>
        <span id="btn-text-{{ item.id }}">Add to Cart</span>
      </button>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

{% block extra_js %}
<script>
  let cartCount = {{ cart_count }};

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let c of cookies) {
        const cookie = c.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  function addToCart(itemId, name, price, btn) {
    fetch(`/food/api/cart/add/${itemId}/`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': getCookie('csrftoken'),
        'Content-Type': 'application/json'
      }
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        cartCount = data.cart_count;
        btn.classList.add('added');
        const txt = btn.querySelector(`#btn-text-${itemId}`);
        txt.textContent = `Added (${data.quantity})`;
        setTimeout(() => {
          btn.classList.remove('added');
          txt.textContent = `Add to Cart`;
        }, 1200);

        // Update bar
        const bar = document.getElementById('cartBar');
        bar.style.display = 'flex';
        document.getElementById('cartBarCount').textContent = cartCount;
      }
    });
  }
</script>
{% endblock %}
{% endblock %}