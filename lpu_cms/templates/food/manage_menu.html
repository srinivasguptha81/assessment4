{% extends 'base.html' %}
{% block title %}Manage Menu ‚Äî {{ stall.name }}{% endblock %}
{% block page_title %}Manage Menu{% endblock %}

{% block extra_css %}
<style>
  .menu-mgmt-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 26px;
    flex-wrap: wrap;
    gap: 12px;
  }
  .menu-mgmt-header h1 {
    font-family: 'Playfair Display', serif;
    font-size: 22px;
    margin: 0;
  }

  /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
  .tab-bar {
    display: flex;
    gap: 4px;
    background: var(--parchment);
    border-radius: 10px;
    padding: 4px;
    margin-bottom: 24px;
    width: fit-content;
  }
  .tab-btn {
    padding: 8px 20px;
    border: none;
    border-radius: 7px;
    background: none;
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    color: var(--slate);
    transition: all 0.18s;
    font-family: 'DM Sans', sans-serif;
  }
  .tab-btn.active {
    background: white;
    color: var(--ink);
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  }
  .tab-pane { display: none; }
  .tab-pane.active { display: block; }

  /* ‚îÄ‚îÄ FORM CARD ‚îÄ‚îÄ */
  .form-card {
    background: white;
    border: 1px solid var(--rule);
    border-radius: 14px;
    padding: 24px 26px;
    margin-bottom: 24px;
  }
  .form-card h2 {
    font-family: 'Playfair Display', serif;
    font-size: 16px;
    margin-bottom: 18px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--rule);
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
  }
  .form-grid .span-2 { grid-column: span 2; }
  @media (max-width: 700px) { .form-grid { grid-template-columns: 1fr; } .form-grid .span-2 { grid-column: span 1; } }

  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group label {
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--slate);
  }
  .form-group input,
  .form-group select,
  .form-group textarea {
    border: 1px solid var(--rule);
    border-radius: 8px;
    padding: 9px 12px;
    font-size: 13.5px;
    font-family: 'DM Sans', sans-serif;
    background: white;
    transition: border-color 0.18s;
    width: 100%;
  }
  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color: var(--gold);
    box-shadow: 0 0 0 3px rgba(201,168,76,0.12);
    outline: none;
  }
  .form-group textarea { resize: vertical; min-height: 72px; }

  .toggle-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
  }
  .toggle-label { font-size: 13px; color: var(--ink); font-weight: 500; }
  .toggle-sub { font-size: 11.5px; color: var(--slate); }

  /* Toggle switch */
  .toggle-switch {
    position: relative;
    width: 42px;
    height: 24px;
    flex-shrink: 0;
  }
  .toggle-switch input { opacity: 0; width: 0; height: 0; }
  .toggle-slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: #cbd5e0;
    border-radius: 24px;
    transition: 0.2s;
  }
  .toggle-slider:before {
    content: '';
    position: absolute;
    width: 18px; height: 18px;
    left: 3px; top: 3px;
    background: white;
    border-radius: 50%;
    transition: 0.2s;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
  }
  .toggle-switch input:checked + .toggle-slider { background: var(--gold); }
  .toggle-switch input:checked + .toggle-slider:before { transform: translateX(18px); }

  /* ‚îÄ‚îÄ MENU ITEMS LIST ‚îÄ‚îÄ */
  .items-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 14px;
  }
  .item-mgmt-card {
    background: white;
    border: 1px solid var(--rule);
    border-radius: 12px;
    padding: 16px;
    position: relative;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .item-mgmt-card:hover {
    border-color: var(--gold);
    box-shadow: 0 4px 16px rgba(0,0,0,0.06);
  }
  .item-mgmt-card.unavailable { opacity: 0.55; }

  .item-card-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 10px;
    margin-bottom: 8px;
  }
  .item-card-name {
    font-weight: 600;
    font-size: 14px;
    color: var(--ink);
    line-height: 1.3;
  }
  .item-card-price {
    font-family: 'Playfair Display', serif;
    font-weight: 700;
    color: var(--gold);
    font-size: 15px;
    flex-shrink: 0;
  }
  .item-card-meta {
    font-size: 11.5px;
    color: var(--slate);
    margin-bottom: 12px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .meta-chip {
    background: var(--parchment);
    border-radius: 4px;
    padding: 2px 7px;
    font-size: 11px;
  }
  .veg-chip { color: #16a34a; }
  .nonveg-chip { color: #dc2626; }

  .item-card-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    border-top: 1px solid var(--rule);
    padding-top: 12px;
  }
  .action-btn {
    flex: 1;
    padding: 7px 0;
    border: 1px solid var(--rule);
    border-radius: 7px;
    background: none;
    font-size: 12px;
    cursor: pointer;
    font-family: 'DM Sans', sans-serif;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    color: var(--ink);
  }
  .action-btn:hover { background: var(--parchment); border-color: var(--gold); }
  .action-btn.danger:hover { background: #fef2f2; border-color: #ef4444; color: #dc2626; }
  .action-btn.success-btn { background: #d4f4dd; border-color: #16a34a; color: #16a34a; }
  .action-btn.warn-btn { background: #fef3c7; border-color: #f59e0b; color: #92400e; }

  .avail-badge {
    font-size: 10.5px;
    padding: 2px 8px;
    border-radius: 10px;
    font-weight: 600;
  }
  .avail-yes { background: #d4f4dd; color: #1a6b35; }
  .avail-no  { background: #fde8e8; color: #b91c1c; }

  /* Category chips */
  .cat-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
  .cat-chip {
    background: white;
    border: 1px solid var(--rule);
    border-radius: 8px;
    padding: 8px 14px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .cat-chip .cat-name { font-weight: 500; }
  .cat-chip .cat-count { font-size: 11px; color: var(--slate); }
  .cat-del-btn {
    background: none;
    border: none;
    color: #ef4444;
    cursor: pointer;
    font-size: 13px;
    padding: 0 2px;
    line-height: 1;
  }

  .empty-section {
    text-align: center;
    padding: 40px 20px;
    color: var(--slate);
    background: var(--parchment);
    border-radius: 10px;
  }
  .empty-section .icon { font-size: 36px; margin-bottom: 10px; }
  .empty-section p { font-size: 13.5px; margin: 0; }

  /* Edit modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 20px;
  }
  .modal-overlay.open { display: flex; }
  .modal-box {
    background: white;
    border-radius: 16px;
    width: 100%;
    max-width: 560px;
    max-height: 90vh;
    overflow-y: auto;
    padding: 28px;
    animation: fadeUp 0.25s ease both;
  }
  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 14px;
    border-bottom: 1px solid var(--rule);
  }
  .modal-header h3 {
    font-family: 'Playfair Display', serif;
    font-size: 17px;
    margin: 0;
  }
  .modal-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: var(--slate);
    line-height: 1;
    padding: 4px;
  }
</style>
{% endblock %}

{% block content %}

<div class="menu-mgmt-header">
  <div>
    <h1>üçΩ Manage Menu</h1>
    <div style="font-size:13px;color:var(--slate);margin-top:3px;">{{ stall.name }} ¬∑ {{ stall.location }}</div>
  </div>
  <a href="{% url 'food:owner_dashboard' %}" class="btn-outline">
    <i class="bi bi-arrow-left"></i> Back to Orders
  </a>
</div>

<!-- TABS -->
<div class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('items', this)">
    <i class="bi bi-grid"></i> Menu Items
  </button>
  <button class="tab-btn" onclick="switchTab('add', this)">
    <i class="bi bi-plus-circle"></i> Add Item
  </button>
  <button class="tab-btn" onclick="switchTab('categories', this)">
    <i class="bi bi-tags"></i> Categories
  </button>
</div>

<!-- ‚ïê‚ïê TAB: MENU ITEMS ‚ïê‚ïê -->
<div class="tab-pane active" id="tab-items">
  {% if menu_items %}
  <div class="items-grid">
    {% for item in menu_items %}
    <div class="item-mgmt-card {% if not item.is_available %}unavailable{% endif %}" id="item-{{ item.id }}">
      <div class="item-card-top">
        <div class="item-card-name">{{ item.name }}</div>
        <div class="item-card-price">‚Çπ{{ item.price }}</div>
      </div>
      <div class="item-card-meta">
        <span class="meta-chip {% if item.is_veg %}veg-chip{% else %}nonveg-chip{% endif %}">
          ‚óè {% if item.is_veg %}Veg{% else %}Non-veg{% endif %}
        </span>
        {% if item.category %}
        <span class="meta-chip">{{ item.category.icon }} {{ item.category.name }}</span>
        {% endif %}
        <span class="meta-chip"><i class="bi bi-stopwatch"></i> {{ item.prep_time }}m</span>
        <span class="avail-badge {% if item.is_available %}avail-yes{% else %}avail-no{% endif %}">
          {% if item.is_available %}Available{% else %}Unavailable{% endif %}
        </span>
      </div>
      {% if item.description %}
      <div style="font-size:12px;color:var(--slate);margin-bottom:10px;line-height:1.5;">{{ item.description }}</div>
      {% endif %}
      <div class="item-card-actions">
        <button class="action-btn" onclick="openEditModal({{ item.id }}, '{{ item.name|escapejs }}', '{{ item.price }}', '{{ item.description|escapejs }}', {{ item.prep_time }}, {{ item.is_veg|yesno:'true,false' }}, {% if item.category %}{{ item.category.id }}{% else %}''{% endif %})">
          <i class="bi bi-pencil"></i> Edit
        </button>
        <form method="post" action="{% url 'food:toggle_item' item.id %}" style="flex:1;">
          {% csrf_token %}
          <button type="submit" class="action-btn {% if item.is_available %}warn-btn{% else %}success-btn{% endif %}" style="width:100%;">
            {% if item.is_available %}<i class="bi bi-eye-slash"></i> Hide{% else %}<i class="bi bi-eye"></i> Show{% endif %}
          </button>
        </form>
        <form method="post" action="{% url 'food:delete_item' item.id %}"
              onsubmit="return confirm('Delete {{ item.name|escapejs }}? This cannot be undone.');"
              style="flex:0 0 auto;">
          {% csrf_token %}
          <button type="submit" class="action-btn danger" style="padding:7px 10px;">
            <i class="bi bi-trash"></i>
          </button>
        </form>
      </div>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-section">
    <div class="icon">üç¥</div>
    <p>No menu items yet.<br>Click <strong>Add Item</strong> to get started.</p>
  </div>
  {% endif %}
</div>

<!-- ‚ïê‚ïê TAB: ADD ITEM ‚ïê‚ïê -->
<div class="tab-pane" id="tab-add">
  <div class="form-card">
    <h2><i class="bi bi-plus-circle text-gold"></i> Add New Menu Item</h2>
    <form method="post" action="{% url 'food:add_item' %}" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="form-grid">
        <div class="form-group span-2">
          <label>Item Name *</label>
          <input type="text" name="name" placeholder="e.g. Masala Maggi" required>
        </div>
        <div class="form-group">
          <label>Price (‚Çπ) *</label>
          <input type="number" name="price" step="0.50" min="1" placeholder="e.g. 40" required>
        </div>
        <div class="form-group">
          <label>Prep Time (minutes)</label>
          <input type="number" name="prep_time" min="1" max="60" value="5">
        </div>
        <div class="form-group span-2">
          <label>Description</label>
          <textarea name="description" placeholder="Optional ‚Äî brief description of the item"></textarea>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select name="category">
            <option value="">‚Äî No Category ‚Äî</option>
            {% for cat in categories %}
            <option value="{{ cat.id }}">{{ cat.icon }} {{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>Photo</label>
          <input type="file" name="photo" accept="image/*">
        </div>
      </div>

      <div style="display:flex;gap:20px;margin-top:16px;flex-wrap:wrap;">
        <div class="toggle-row">
          <label class="toggle-switch">
            <input type="checkbox" name="is_veg" checked>
            <span class="toggle-slider"></span>
          </label>
          <div>
            <div class="toggle-label">Vegetarian</div>
            <div class="toggle-sub">Green dot shown to students</div>
          </div>
        </div>
        <div class="toggle-row">
          <label class="toggle-switch">
            <input type="checkbox" name="is_available" checked>
            <span class="toggle-slider"></span>
          </label>
          <div>
            <div class="toggle-label">Available Now</div>
            <div class="toggle-sub">Uncheck to hide from menu</div>
          </div>
        </div>
      </div>

      <hr class="divider">
      <div style="display:flex;gap:10px;">
        <button type="submit" class="btn-gold">
          <i class="bi bi-plus-circle"></i> Add to Menu
        </button>
        <button type="reset" class="btn-outline">Clear</button>
      </div>
    </form>
  </div>
</div>

<!-- ‚ïê‚ïê TAB: CATEGORIES ‚ïê‚ïê -->
<div class="tab-pane" id="tab-categories">
  <div class="form-card">
    <h2><i class="bi bi-tags text-gold"></i> Add Category</h2>
    <form method="post" action="{% url 'food:add_category' %}">
      {% csrf_token %}
      <div class="form-grid">
        <div class="form-group">
          <label>Category Name *</label>
          <input type="text" name="name" placeholder="e.g. Snacks" required>
        </div>
        <div class="form-group">
          <label>Emoji Icon</label>
          <input type="text" name="icon" placeholder="üçü" maxlength="5" value="üçΩ">
        </div>
      </div>
      <div style="margin-top:14px;">
        <button type="submit" class="btn-gold">
          <i class="bi bi-plus"></i> Add Category
        </button>
      </div>
    </form>
  </div>

  <div style="margin-bottom:14px;font-size:13px;font-weight:500;color:var(--ink);">
    Existing Categories
  </div>
  {% if categories %}
  <div class="cat-list">
    {% for cat in categories %}
    <div class="cat-chip">
      <span style="font-size:18px;">{{ cat.icon }}</span>
      <div>
        <div class="cat-name">{{ cat.name }}</div>
        <div class="cat-count">{{ cat.menuitem_set.count }} items</div>
      </div>
      <form method="post" action="{% url 'food:delete_category' cat.id %}"
            onsubmit="return confirm('Delete category {{ cat.name|escapejs }}?');" style="margin:0;">
        {% csrf_token %}
        <button type="submit" class="cat-del-btn" title="Delete">
          <i class="bi bi-x-circle"></i>
        </button>
      </form>
    </div>
    {% endfor %}
  </div>
  {% else %}
  <div class="empty-section">
    <div class="icon">üè∑Ô∏è</div>
    <p>No categories yet. Add one above.</p>
  </div>
  {% endif %}
</div>

<!-- ‚ïê‚ïê EDIT MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="editModal">
  <div class="modal-box">
    <div class="modal-header">
      <h3>‚úèÔ∏è Edit Menu Item</h3>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <form method="post" id="editForm" action="" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="form-grid">
        <div class="form-group span-2">
          <label>Item Name *</label>
          <input type="text" name="name" id="edit-name" required>
        </div>
        <div class="form-group">
          <label>Price (‚Çπ) *</label>
          <input type="number" name="price" id="edit-price" step="0.50" min="1" required>
        </div>
        <div class="form-group">
          <label>Prep Time (min)</label>
          <input type="number" name="prep_time" id="edit-prep" min="1" max="60">
        </div>
        <div class="form-group span-2">
          <label>Description</label>
          <textarea name="description" id="edit-desc"></textarea>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select name="category" id="edit-cat">
            <option value="">‚Äî No Category ‚Äî</option>
            {% for cat in categories %}
            <option value="{{ cat.id }}">{{ cat.icon }} {{ cat.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label>New Photo (optional)</label>
          <input type="file" name="photo" accept="image/*">
        </div>
      </div>
      <div style="display:flex;gap:20px;margin-top:16px;flex-wrap:wrap;">
        <div class="toggle-row">
          <label class="toggle-switch">
            <input type="checkbox" name="is_veg" id="edit-veg">
            <span class="toggle-slider"></span>
          </label>
          <div class="toggle-label">Vegetarian</div>
        </div>
        <div class="toggle-row">
          <label class="toggle-switch">
            <input type="checkbox" name="is_available" id="edit-avail">
            <span class="toggle-slider"></span>
          </label>
          <div class="toggle-label">Available Now</div>
        </div>
      </div>
      <hr class="divider">
      <div style="display:flex;gap:10px;">
        <button type="submit" class="btn-gold"><i class="bi bi-check-lg"></i> Save Changes</button>
        <button type="button" class="btn-outline" onclick="closeModal()">Cancel</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Tab switching
  function switchTab(tabId, btn) {
    document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    btn.classList.add('active');
  }

  // Auto-switch to Add tab if redirected with ?tab=add
  if (window.location.search.includes('tab=add')) {
    document.querySelectorAll('.tab-btn')[1].click();
  }

  // Edit modal
  function openEditModal(id, name, price, desc, prep, isVeg, catId) {
    document.getElementById('editForm').action = `/food/menu/edit/${id}/`;
    document.getElementById('edit-name').value = name;
    document.getElementById('edit-price').value = price;
    document.getElementById('edit-desc').value = desc;
    document.getElementById('edit-prep').value = prep;
    document.getElementById('edit-veg').checked = isVeg;
    document.getElementById('edit-avail').checked = true;

    const catSel = document.getElementById('edit-cat');
    catSel.value = catId || '';

    document.getElementById('editModal').classList.add('open');
  }

  function closeModal() {
    document.getElementById('editModal').classList.remove('open');
  }

  // Close modal on overlay click
  document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });
</script>
{% endblock %}